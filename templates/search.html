{% extends "layout.html" %}
{% block title %} Noita Builds{% endblock %}
{%block main%}
<head>
    <link href="/static/spellBorders.css"  rel="stylesheet" >
</head>
<style>
    .wand-icon{
        width: 128px; height: 64px;
    }
    .spell-icon-sm{
        width: 32px; height: 32px;
    }

    .spell-icon-lg{
        width: 64px; height: 64px;
    }

    .spell-menu{
        display: grid;
        row-gap: 8px;
        column-gap: 8px;
        grid-template-columns: 32px 32px 32px 32px 32px 32px 32px 32px 32px 32px 32px 32px 32px 32px;
    }

    .spell-item{
        width: 32px; height: 32px;
    }
</style>

<script>
    const submitComment = (id) => {
        var date1 = new Date()
        document.getElementById('date-'+id).value = date1
        document.getElementById("form-"+id).submit();
    }

    const showConfirmDeleteComment = (id_comment, id_build) => {
        comment = document.getElementById("comment-"+id_comment).cloneNode(true)
        comment.classList.add("n-box")
        comment_html = comment.outerHTML

        document.getElementById("delete-comment-warning").innerHTML =
        `
        <div class="n-box">
            ${comment_html}
            <div style="text-align:center;">
                <span>Are you sure you want to delete this comment?</span>
            </div>
            <div class="d-flex justify-content-center">
                <a 
                    href="/removeComment/${id_comment}?state={{state}}&buildID=${id_build}"
                    class="n-box" 
                    style="background-color: rgba(198,59,59,0.7); cursor:pointer;">
                    <span>Delete Comment</span>
                </a>

                <div 
                    class="n-box"
                    style="cursor:pointer;"
                    onclick="document.getElementById('delete-comment-warning').style.display = 'none';"
                    >Cancel</div>
                </div> 
            </div>
        `

        document.getElementById("delete-comment-warning").style.display = "flex"
    }

</script>

<div class="n-column">
    <span class="nt-font n-title text-center">Recent Builds</span>
    <div class="">
    {% for bld in builds %}
    <div id="build-{{bld['id']}}"class="my-3">
        <div class="n-box mx-2">
            <div class="n-container mt-3">
                <div class="d-flex align-items-center justify-content-center" style="width: 256px;">
                    <div class="d-flex pi-image wand-frame align-items-center justify-content-center">
                        <img class="pi-image" src="/static/img/wands/wand_{{bld['image']}}.png" height="48px">
                    </div>
                </div>

                <div class="w-100 mx-2">
                    <span class="np-font" style="font-size: 24px;">{{bld['title']}}</span>
                    <div class="spell-slots-frame" style="margin-bottom:0%; margin-top:4px;">
                        {%for img in bld['spells']%}
                        <a class="spell-item {{img['css_type']}}">
                            {{img['img_html'] | safe}}
                        </a>
                        {%endfor%}
                    </div>
                </div>
            </div>

            <div class="align-self-center align-items-center justify-content-start d-flex mx-1 my-1">
                <div class="w-100">
                    <span class="np-font" style="font-size: 12px;">Created by</span>
                    <img class="rounded-circle" src="{{bld['author']['img']}}" height="32px">
                    <span class="np-font" style="font-size: 12px;">{{bld['author']['name']}}</span>
                </div>
                <span class="np-font">{{bld['likes']}}</span>
                {% for like in login_session['user']['liked-posts'] if bld['id'] == like%}
                <a href="/updateLike/{{bld['id']}}?state={{state}}">
                    <img class="pi-image" src="/static/liked.gif" height="36px"> 
                </a>
                {% else %}
                <a href="/updateLike/{{bld['id']}}?state={{state}}">
                    <img class="pi-image" src="/static/unliked.png" height="36px"> 
                </a>

                {% endfor %}
                
            </div>

        <div class="d-flex mx-2 mt-3">
            <div class="n-column w-100" style="box-shadow: 0 -3px 0 #948064; background-color: rgba(60, 60, 60, 0.7)">
                <span class="np-font my-1 mx-1" style="font-size: small; color:gray; font-style:italic;">Description:</span>
                <span class="np-font my-1 mx-1" style="font-size:medium">{{bld['description']}}</span>
            </div>
        </div>

        <form id="form-{{bld['id']}}" class="d-flex align-items-center m-4" method="POST" action="/addComment/{{bld['id']}}?state={{state}}">
            <img class="rounded-circle mx-3" src="{{login_session['user']['avatar_url']}}" height="48px">
            <textarea
                id="comment-{{bld['id']}}"
                name="comment"
                class="np-font mx-2 w-100" 
                style="resize: none;box-shadow: 0 3px 0 #948064; background-color:rgba(60, 60, 60, 0.7); color:white;" 
                placeholder="Add a comment!"
                rows="1"
                maxlength="400"></textarea>

            <input id="date-{{bld['id']}}" type="text" name='date' hidden>
            <input  
                onclick="submitComment({{bld['id']}})"
                class="pi-image n-submit"
                type="button" 
                style="
                    width:36px; height:36px;
                    border:none; 
                    background-color:transparent;
                    background-image: url(/static/send.png);
                    "
                >
            <input type="text" value="" hidden>
        </form>

        <div>
        {% for cmt in bld['comments']%}
            {% if not cmt['is-deleted']%}
            <div class="n-box d-flex justify-content-between">
                <div id="comment-{{cmt['id']}}" class="d-flex np-font">
                    <img class="rounded-circle mx-3" src="{{cmt['author']['img']}}" height="38px">
                    <div>
                        <div class="d-flex align-items-end">
                            <span style="font-size: 12px;">{{cmt['author']['name']}}</span>
                            <span 
                                style="
                                font-size: 12px; 
                                margin-left:12px;
                                color: gray;">{{cmt['date']}}</span>
                        </div>
                        <span>{{cmt['content']}}</span>
                    </div>
                </div>
                {% if cmt['author-id'] == login_session['user']['id'] %}
                    <a onclick="showConfirmDeleteComment({{cmt['id']}}, {{bld['id']}})">
                        Delete
                    </a>
                {%endif%}
            </div>
            {%else%}
                <div class="n-box np-font">
                    <span style="font-style: italic; color:gray;">Deleted Comment</span>
                </div>
            {%endif%}
        {% endfor %}
        </div>
    </div>
    </div>
    {% endfor %}
    </div>

    <aside id="delete-comment-warning" class="warning-screen np-font" style="display:none">
    </aside>
</div>
{%endblock%}