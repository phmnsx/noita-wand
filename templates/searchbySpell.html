{% extends "layout.html" %}
{% block title %} Noita Builds{% endblock %}
{%block main%}
<head>
    <link href="/static/spellBorders.css" rel="stylesheet" >
</head>
<style>
    .wand-icon{
        width: 128px; height: 64px;
    }
    .spell-icon-sm{
        width: 32px; height: 32px;
    }

    .spell-icon-lg{
        width: 64px; height: 64px;
    }

    .spell-menu{
        display: grid;
        row-gap: 8px;
        column-gap: 8px;
        grid-template-columns: 32px 32px 32px 32px 32px 32px 32px 32px 32px 32px 32px 32px 32px 32px;
    }

    .spell-item{
        width: 32px; height: 32px;
    }

    .popover{
        padding: 0px;
        text-align: center;
        background-color: black;
        white-space: pre-line;
    }

    main{
        margin-left: 4%;
        margin-right: 4%;  
    }
</style>

<script>
    var page = 0
    var addedSpells = []
    const SPELLS = {{spells | tojson}};

    const getSearchResult = () => {
        var spells =  document.getElementById('spell-list').value
        var slots =  document.getElementById('spell-slots-value').value
        fetch(`getBuildBySpell/${page}?state={{state}}`, {
            method: "POST",
            body: JSON.stringify({
                spells: spells,
                slots: parseInt(slots)
            }),
            headers: {
                'Content-type': 'application/json; charset=UTF-8',
            }
        })
        .then(response => {
            return response.text();
        })
        .then(html =>  {
            document.getElementById("builds-result").innerHTML = html
        })
    }

    const addSpell = (index) => { 
        if(addedSpells.length == parseInt(document.getElementById('spell-slots-value').value) && addedSpells.length < 26) {
            document.getElementById('spell-slots-value').value = parseInt(document.getElementById('spell-slots-value').value) + 1
        }
        if(addedSpells.length < 26) {
            addedSpells.push(index)
        }
        document.getElementById('spell-list').value = addedSpells.toString()
        defineSpellsSlots()
    }

    const removeSpell = (index) => {
        addedSpells.splice(index, 1)
        document.getElementById('spell-list').value = addedSpells.toString()
        defineSpellsSlots()
    }

    const removeSlot = () => {
        document.getElementById('spell-slots-value').value = parseInt(document.getElementById('spell-slots-value').value) - 1
        defineSpellsSlots()
    }

    const defineSpellsSlots = () => {
        let amount = document.getElementById('spell-slots-value').value
        document.getElementById('spell-slots').innerHTML = ""

        for (let i=0; i < parseInt(amount); i++){
            if (typeof addedSpells[i] !== 'undefined'){
                document.getElementById('spell-slots').innerHTML += `<div class="spell-slot" onclick="removeSpell(${i})">
                    <div class="pi-image ${SPELLS[addedSpells[i]-1].css_type} spell-item" style="background-size: cover;background-image: url(/static/img/spells/${SPELLS[addedSpells[i]-1].img}"></div>
                </div>`
            } else{
                document.getElementById('spell-slots').innerHTML += `<div class="spell-slot" onclick="removeSlot()"></div>`
            }
        }
        if(amount == 0) {
            document.getElementById('spell-slots').innerHTML += `<span class="np-font" style="position:absolute; text-align:center">No spells slots :(</span>`
        }
    }
</script>

<div class="d-flex">
    <div class="n-box w-100">
        <input id="spell-list" type="text" name="spell-list" value="" hidden>
        <label for="spell-slots-value">Amount of Slots</label>
        <input id="spell-slots-value" name="spell-slots-value" type="number" value="1">
        <span class="np-font">Spells</span>
        <div id="spell-slots" class="spell-slots-frame n-container n-center">           
        </div>
        <a
            onclick="getSearchResult()"
            style="cursor:pointer;">
            <img class="pi-image" src="/static/search.png" height="64" width="64">
        </a>

        <div id="builds-result"></div>
    </div>
    
    <div class="n-box text-center">
        <span class="np-font">Spells list</span>
        <div class="spell-menu n-center">
            {% for spell in spells %} 
            <a 
            class="spell-item {{spell['css_type']}}" 
            onclick="addSpell({{loop.index}})">
            {{spell['img_html'] | safe}}
            </a>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}